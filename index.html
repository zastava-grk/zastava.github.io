import React, { useState } from 'react';
import { View, Text, Button, TextInput, FlatList, StyleSheet, Alert } from 'react-native';
import { WebView } from 'react-native-webview';

const menu = [
  { id: '1', name: 'Борщ', price: 120 },
  { id: '2', name: 'Вареники з картоплею', price: 100 },
  { id: '3', name: "Салат 'Олів'є'", price: 90 },
  { id: '4', name: 'Компот', price: 30 },
];

export default function App() {
  const [cart, setCart] = useState([]);
  const [address, setAddress] = useState('');
  const [showWebView, setShowWebView] = useState(false);
  const [liqpayUrl, setLiqpayUrl] = useState('');

  const addToCart = (item) => setCart([...cart, item]);

  const total = cart.reduce((sum, item) => sum + item.price, 0);

  const startPayment = async () => {
    if (!address) {
      Alert.alert('Помилка', 'Будь ласка, введіть адресу доставки');
      return;
    }

    // Створення даних LiqPay
    const data = {
      public_key: 'sandbox_i000000000',
      version: '3',
      action: 'pay',
      amount: total,
      currency: 'UAH',
      description: Оплата замовлення. Доставка: ${address},
      order_id: Date.now().toString(),
      sandbox: '1',
    };

    // Відправка на бекенд для генерації data та signature
    try {
      const response = await fetch('https://ВАШ-СЕРВЕР/api/liqpay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const { data: encodedData, signature } = await response.json();
      const html = 
        <form method="POST" action="https://www.liqpay.ua/api/3/checkout" accept-charset="utf-8">
          <input type="hidden" name="data" value="${encodedData}" />
          <input type="hidden" name="signature" value="${signature}" />
          <input type="submit" value="Оплатити" />
        </form>
        <script>document.forms[0].submit();</script>
      ;

      setLiqpayUrl(data:text/html;base64,${Buffer.from(html).toString('base64')});
      setShowWebView(true);
    } catch (error) {
      Alert.alert('Помилка', 'Не вдалося ініціювати оплату');
    }
  };

  if (showWebView) {
    return <WebView source={{ uri: liqpayUrl }} onNavigationStateChange={(nav) => {
      if (nav.url.includes('success')) {
        setShowWebView(false);
        Alert.alert('Успіх', 'Оплата пройшла успішно!');
        setCart([]);
        setAddress('');
      }
    }} />;
  }

  return (
    <View style={styles.container}>
      <Text style={styles.header}>Ресторан "Смачного!"</Text>
      <FlatList
        data={menu}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <View style={styles.item}>
            <Text>{item.name} — {item.price} грн</Text>
            <Button title="Додати" onPress={() => addToCart(item)} />
          </View>
        )}
      />

      <Text style={styles.cartTitle}>Кошик:</Text>
      {cart.map((item, index) => (
        <Text key={index}>{item.name} — {item.price} грн</Text>
      ))}

      <Text style={styles.total}>Загальна сума: {total} грн</Text>

      <TextInput
        style={styles.input}
        placeholder="Ваша адреса"
        value={address}
        onChangeText={setAddress}
      />

      <Button title="Оплатити онлайн" onPress={startPayment} />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    padding: 20,
    paddingTop: 50,
  },
  header: {
    fontSize: 24,
    fontWeight: 'bold',
    marginBottom: 20,
  },
  item: {
    marginBottom: 10,
  },
  cartTitle: {
    marginTop: 20,
    fontWeight: 'bold',
  },
  total: {
    marginTop: 10,
    fontWeight: 'bold',
  },
  input: {
    borderWidth: 1,
    borderColor: '#ccc',
    marginVertical: 10,
    padding: 10,
    borderRadius: 5,
  },
});
